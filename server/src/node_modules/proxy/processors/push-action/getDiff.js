const execSync = require('child_process').execSync;
const Step = require('proxy/actions').Step;


const exec = (req, action) => {
  const step = new Step('diff');

  try {
    console.log(action.commitFrom)
    // Some push actions have no changes - so we need to check
    if (action.commitFrom != '0000000000000000000000000000000000000000') {
      const path = `${action.proxyGitPath}/${action.repoName}`;
      const cmd = `git diff ${action.commitFrom} ${action.commitTo}`

      step.log(`executing "${cmd}" in foler ${path}`);

      // Get the diff
      const content = execSync(cmd, { cwd: path }).toString('utf-8');
      
      step.log(`completed ${cmd}`);
      step.setContent(content);
    }  
  }
  catch (e) {
    step.setError(e.message);
    throw e;
  }
  finally {
    action.addStep(step)
    return action;
  }
};

exec.displayName = 'getDiff.exec';
exports.exec = exec;
